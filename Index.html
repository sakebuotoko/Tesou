<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‰‹ç›¸ãƒãƒˆãƒ©ãƒ¼</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", Meiryo, sans-serif;
    background: linear-gradient(135deg, #b7e4c7, #95d5b2, #74c69d);
    margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  }
  h1 {
    margin-top: 20px; margin-bottom: 10px;
  }
  #camera-section, #result-section, #battle-section {
    width: 90vw; max-width: 480px; background: rgba(255 255 255 / 0.85); border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  video, canvas {
    width: 100%; border-radius: 10px; background: #222;
  }
  button {
    margin-top: 10px; padding: 12px 20px; font-size: 1.1rem; border-radius: 10px; border: none; background: #4caf50; color: white; cursor: pointer;
    user-select: none;
  }
  button:disabled {
    background: #a5d6a7; cursor: not-allowed;
  }
  #stats {
    margin-top: 10px; font-weight: 700; font-size: 1.1rem;
  }
  #battle-controls {
    margin-top: 15px; display: flex; gap: 15px; justify-content: center;
  }
  .atk-btn {
    background: #f44336;
    flex: 1;
  }
  .def-btn {
    background: #2196f3;
    flex: 1;
  }
  #battle-log {
    margin-top: 15px; height: 120px; overflow-y: auto; background: #fff; border-radius: 8px; padding: 10px; font-size: 0.95rem; line-height: 1.3; color: #222;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
  }
  #player-hp, #cpu-hp {
    font-weight: 700;
    margin-top: 8px;
  }
</style>
</head>
<body>
  <h1>æ‰‹ç›¸ãƒãƒˆãƒ©ãƒ¼</h1>

  <section id="camera-section" aria-label="æ‰‹ç›¸æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³">
    <video id="video" autoplay playsinline></video>
    <button id="capture-btn">æ‰‹ç›¸ã‚’æ’®ã‚‹</button>
    <canvas id="canvas" style="display:none;"></canvas>
  </section>

  <section id="result-section" aria-label="èƒ½åŠ›æ±ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="display:none;">
    <h2>ã‚ãªãŸã®èƒ½åŠ›</h2>
    <div id="stats"></div>
    <button id="start-battle-btn">ãƒãƒˆãƒ«é–‹å§‹ï¼</button>
  </section>

  <section id="battle-section" aria-label="ãƒãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="display:none;">
    <h2>ãƒãƒˆãƒ«ï¼ ã‚ãªãŸ vs CPU</h2>
    <div id="player-hp"></div>
    <div id="cpu-hp"></div>
    <div id="battle-controls">
      <button id="attack-btn" class="atk-btn">æ”»æ’ƒï¼</button>
      <button id="defend-btn" class="def-btn">é˜²å¾¡ï¼</button>
    </div>
    <div id="battle-log" aria-live="polite"></div>
  </section>

<script>
(() => {
  const video = document.getElementById('video');
  const captureBtn = document.getElementById('capture-btn');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const resultSection = document.getElementById('result-section');
  const statsDiv = document.getElementById('stats');
  const startBattleBtn = document.getElementById('start-battle-btn');
  const battleSection = document.getElementById('battle-section');
  const playerHpDiv = document.getElementById('player-hp');
  const cpuHpDiv = document.getElementById('cpu-hp');
  const battleLog = document.getElementById('battle-log');
  const attackBtn = document.getElementById('attack-btn');
  const defendBtn = document.getElementById('defend-btn');

  let stream = null;
  let player = { hp: 0, atk: 0, def: 0 };
  let cpu = { hp: 0, atk: 0, def: 0 };
  let playerTurn = true;
  let battleOngoing = false;

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    } catch(e) {
      alert('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  }

  function analyzeImage() {
    // Canvasã«å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imgData.data;

    // ç°¡æ˜“åˆ†æï¼šç”»åƒã®æ˜ã‚‹ã•ã®å¹³å‡å€¤ã‚’è¨ˆç®—ã—ã€ãã‚Œã‚’å…ƒã«èƒ½åŠ›å€¤ã®åŸºç¤ã«ã™ã‚‹
    let brightnessSum = 0;
    let edgeCount = 0;

    // ç”»åƒã‚µã‚¤ã‚ºã‚’å°‘ã—ç¸®å°ã—ã¦å‡¦ç†è»½æ¸›ï¼ˆä¾‹ï¼š5pxåˆ»ã¿ï¼‰
    const step = 5;
    for(let y = 0; y < canvas.height - step; y += step) {
      for(let x = 0; x < canvas.width - step; x += step) {
        // RGBå€¤
        const i = (y * canvas.width + x) * 4;
        const r = data[i], g = data[i+1], b = data[i+2];
        // æ˜ã‚‹ã•ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ï¼‰
        const bright = 0.299*r + 0.587*g + 0.114*b;
        brightnessSum += bright;

        // ç°¡å˜ãªã‚¨ãƒƒã‚¸åˆ¤å®šï¼ˆéš£ã®ãƒ”ã‚¯ã‚»ãƒ«ã¨æ˜ã‚‹ã•å·®ã‚’è¦‹ã¦ç·šã£ã½ã„ã‹åˆ¤å®šï¼‰
        const iRight = (y * canvas.width + (x+step)) * 4;
        const rR = data[iRight], gR = data[iRight+1], bR = data[iRight+2];
        const brightRight = 0.299*rR + 0.587*gR + 0.114*bR;
        if(Math.abs(bright - brightRight) > 40) edgeCount++;

        const iDown = ((y+step) * canvas.width + x) * 4;
        const rD = data[iDown], gD = data[iDown+1], bD = data[iDown+2];
        const brightDown = 0.299*rD + 0.587*gD + 0.114*bD;
        if(Math.abs(bright - brightDown) > 40) edgeCount++;
      }
    }
    const avgBrightness = brightnessSum / ((canvas.width/step)*(canvas.height/step));
    // console.log("å¹³å‡æ˜ã‚‹ã•:", avgBrightness);
    // console.log("ç·šã£ã½ã„ã‚¨ãƒƒã‚¸æ•°:", edgeCount);

    // ã“ã“ã§èƒ½åŠ›å€¤ã‚’ç®—å‡ºï¼ˆé›°å›²æ°—é‡è¦–ï¼‰
    // æ˜ã‚‹ã•ãŒé«˜ã„ã»ã©HPãŒé«˜ããªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
    // ã‚¨ãƒƒã‚¸æ•°ãŒå¤šã„ã»ã©ATKã¨DEFãŒä¸ŠãŒã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸

    const hpBase = Math.min(100, Math.max(40, avgBrightness)); // 40~100 ã®ç¯„å›²
    const atkBase = Math.min(30, Math.max(10, edgeCount / 20)); // 10~30 ã®ç¯„å›²ï¼ˆedgeCountã‚’ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    const defBase = Math.min(20, Math.max(5, edgeCount / 30));  // 5~20 ã®ç¯„å›²

    // ãƒ©ãƒ³ãƒ€ãƒ è£œæ­£ Â±10% ç¨‹åº¦
    function rndAdjust(val) {
      const rate = 0.1;
      return Math.floor(val * (1 + (Math.random()*2 -1)*rate));
    }
    player.hp = rndAdjust(hpBase);
    player.atk = rndAdjust(atkBase);
    player.def = rndAdjust(defBase);
  }

  function showStats() {
    statsDiv.innerHTML = `
      <p>HP: ${player.hp}</p>
      <p>æ”»æ’ƒåŠ› (ATK): ${player.atk}</p>
      <p>é˜²å¾¡åŠ› (DEF): ${player.def}</p>
    `;
  }

  function initCPU() {
    // CPUã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èƒ½åŠ›ã®Â±15%ç¨‹åº¦ã§ä½œã‚‹
    function rndAdjustCPU(val) {
      const rate = 0.15;
      return Math.max(5, Math.floor(val * (1 + (Math.random()*2 -1)*rate)));
    }
    cpu.hp = rndAdjustCPU(player.hp);
    cpu.atk = rndAdjustCPU(player.atk);
    cpu.def = rndAdjustCPU(player.def);
  }

  function updateHP() {
    playerHpDiv.textContent = `ã‚ãªãŸã®HP: ${player.hp}`;
    cpuHpDiv.textContent = `CPUã®HP: ${cpu.hp}`;
  }

  function logBattle(text) {
    const p = document.createElement('p');
    p.textContent = text;
    battleLog.appendChild(p);
    battleLog.scrollTop = battleLog.scrollHeight;
  }

  function disableBattleBtns(disable) {
    attackBtn.disabled = disable;
    defendBtn.disabled = disable;
  }

  function playerAttack() {
    if(!battleOngoing) return;
    disableBattleBtns(true);
    // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ï¼ˆæ”»æ’ƒåŠ›-é˜²å¾¡åŠ›Ã—0.5+ãƒ©ãƒ³ãƒ€ãƒ (1ã€œ5)ï¼‰
    let damage = player.atk - cpu.def * 0.5 + (Math.floor(Math.random() * 5) + 1);
    damage = Math.max(1, Math.floor(damage));
    cpu.hp -= damage;
    cpu.hp = Math.max(0, cpu.hp);
    logBattle(`ã‚ãªãŸã®æ”»æ’ƒï¼ CPUã«${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸`);
    updateHP();
    if(cpu.hp <= 0){
      logBattle("CPUã‚’å€’ã—ãŸï¼ã‚ãªãŸã®å‹ã¡ã§ã™ğŸ‰");
      battleOngoing = false;
      disableBattleBtns(true);
      return;
    }
    setTimeout(cpuTurn, 1500);
  }

  function playerDefend() {
    if(!battleOngoing) return;
    disableBattleBtns(true);
    logBattle("ã‚ãªãŸã¯é˜²å¾¡ã®æ§‹ãˆ");
    setTimeout(cpuTurn, 1500);
  }

  function cpuTurn() {
    if(!battleOngoing) return;
    // CPUã¯60%æ”»æ’ƒã€40%é˜²å¾¡
    const cpuAction = (Math.random() < 0.6) ? 'attack' : 'defend';
    if(cpuAction === 'attack'){
      // CPUæ”»æ’ƒ
      let damage = cpu.atk - player.def * 0.5 + (Math.floor(Math.random() * 5) + 1);
      damage = Math.max(1, Math.floor(damage));
      player.hp -= damage;
      player.hp = Math.max(0, player.hp);
      logBattle(`CPUã®æ”»æ’ƒï¼ ã‚ãªãŸã«${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸`);
      updateHP();
      if(player.hp <= 0){
        logBattle("ã‚ãªãŸã¯å€’ã•ã‚Œã¾ã—ãŸâ€¦CPUã®å‹ã¡ã§ã™ã€‚");
        battleOngoing = false;
        disableBattleBtns(true);
        return;
      }
    } else {
      logBattle("CPUã¯é˜²å¾¡ã®æ§‹ãˆ");
    }
    disableBattleBtns(false);
  }

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  captureBtn.addEventListener('click', () => {
    analyzeImage();
    showStats();
    resultSection.style.display = 'block';
    battleSection.style.display = 'none';
  });

  startBattleBtn.addEventListener('click', () => {
    initCPU();
    updateHP();
    battleLog.textContent = '';
    battleSection.style.display = 'block';
    playerTurn = true;
    battleOngoing = true;
    disableBattleBtns(false);
  });

  attackBtn.addEventListener('click', () => {
    if(!battleOngoing) return;
    playerAttack();
  });

  defendBtn.addEventListener('click', () => {
    if(!battleOngoing) return;
    playerDefend();
  });

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚«ãƒ¡ãƒ©èµ·å‹•
  startCamera();

})();
</script>
</body>
</html>
